
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitLog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom); 
        }
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f1f5f9; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        .custom-scrollbar::-webkit-scrollbar { width: 0px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .active-nav { color: #2563eb; }
        .active-nav .nav-dot { opacity: 1; transform: scale(1); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6 !important; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        /* é’ˆå¯¹ iPhone 13 é€‚é… */
        nav {
            padding-bottom: calc(15px + var(--safe-bottom));
            height: calc(85px + var(--safe-bottom));
        }
        main {
            padding-bottom: calc(100px + var(--safe-bottom));
        }
        .header-pt {
            padding-top: calc(1.2rem + var(--safe-top));
        }
    </style>
</head>
<body class="text-slate-900 overflow-hidden">
    <div class="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-2xl relative overflow-hidden">
        
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="z-30 bg-white/95 backdrop-blur-md sticky top-0 border-b border-slate-100 px-6 py-3 flex items-center header-pt">
            <h1 class="text-3xl font-black bg-gradient-to-r from-blue-600 to-indigo-500 bg-clip-text text-transparent tracking-tighter shrink-0">FITLOG</h1>
            <div class="h-4 w-[1px] bg-slate-200 mx-4 shrink-0"></div>
            <p id="header-banner" class="text-[14px] text-slate-400 font-bold italic truncate flex-1 pl-1"></p>
        </header>

        <!-- ä¸»ä½“å†…å®¹ -->
        <main id="main-scroll" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/30">
            
            <!-- é¦–é¡µ -->
            <div id="tab-home" class="tab-content active p-4 space-y-6 pt-6">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-600 rounded-[2rem] p-6 text-white card-shadow relative overflow-hidden group">
                        <div id="stat-total" class="text-3xl font-black mono leading-none">0</div>
                        <div class="text-[11px] opacity-80 font-black tracking-widest mt-2">ç´¯è®¡è®­ç»ƒ</div>
                    </div>
                    <div class="bg-slate-900 rounded-[2rem] p-6 text-white card-shadow relative overflow-hidden group">
                        <div id="stat-month" class="text-3xl font-black mono leading-none">0</div>
                        <div class="text-[11px] opacity-80 font-black tracking-widest mt-2">æœ¬æœˆè®­ç»ƒ</div>
                    </div>
                </div>

                <div class="flex justify-between items-end px-1">
                    <div>
                        <h2 class="text-xl font-black text-slate-800">è®­ç»ƒæ—¥å¿—</h2>
                        <p class="text-[11px] text-slate-400 font-bold">åšæŒå°±æ˜¯èƒœåˆ©</p>
                    </div>
                    <button onclick="openEditor()" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-[13px] font-black shadow-lg shadow-blue-100 active:scale-95 transition-all">
                        è®°ä¸€ç¬”
                    </button>
                </div>

                <div id="log-list" class="space-y-4"></div>
            </div>

            <!-- æ—¥å† -->
            <div id="tab-calendar" class="tab-content p-4 space-y-4">
                <div class="bg-white rounded-[2rem] p-6 border border-slate-100 card-shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="calendar-title" class="text-xl font-black text-slate-800"></h2>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-xl text-slate-500">â†</button>
                            <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-xl text-slate-500">â†’</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center text-[11px] font-black text-slate-300 mb-2">
                        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-y-4 gap-x-2 text-center"></div>
                </div>
                <div id="calendar-detail"></div>
            </div>

            <!-- ç»Ÿè®¡ -->
            <div id="tab-stats" class="tab-content p-4 space-y-6">
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 text-center shadow-sm">
                        <div class="text-[10px] font-black text-red-500 mb-1">æ·±è¹² PR</div>
                        <div id="pr-squat" class="text-lg font-black mono">--</div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 text-center shadow-sm">
                        <div class="text-[10px] font-black text-blue-500 mb-1">å§æ¨ PR</div>
                        <div id="pr-bench" class="text-lg font-black mono">--</div>
                    </div>
                    <div class="bg-white p-4 rounded-2xl border border-slate-100 text-center shadow-sm">
                        <div class="text-[10px] font-black text-indigo-500 mb-1">ç¡¬æ‹‰ PR</div>
                        <div id="pr-deadlift" class="text-lg font-black mono">--</div>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="bg-white rounded-[1.5rem] p-5 card-shadow border border-slate-100">
                        <h3 class="text-[13px] font-black text-slate-800 mb-3">æ€»è®­ç»ƒå®¹é‡è¶‹åŠ¿ (KG)</h3>
                        <canvas id="volume-chart" height="180"></canvas>
                    </div>
                    <div class="bg-white rounded-[1.5rem] p-5 card-shadow border border-slate-100">
                        <h3 class="text-[13px] font-black text-slate-800 mb-3">SBD åŠ›é‡è¶‹åŠ¿ (KG)</h3>
                        <canvas id="sbd-chart" height="180"></canvas>
                    </div>
                    <div class="bg-white rounded-[1.5rem] p-5 card-shadow border border-slate-100">
                        <h3 class="text-[13px] font-black text-slate-800 mb-3 text-orange-500">ä½“é‡å˜åŒ– (KG)</h3>
                        <canvas id="weight-chart" height="150"></canvas>
                    </div>
                    <div class="bg-white rounded-[1.5rem] p-5 card-shadow border border-slate-100">
                        <h3 class="text-[13px] font-black text-slate-800 mb-3 text-pink-500">ä½“è„‚æ¯”ä¾‹ (%)</h3>
                        <canvas id="fat-chart" height="150"></canvas>
                    </div>
                </div>
            </div>

            <!-- åŠ¨ä½œåº“ -->
            <div id="tab-library" class="tab-content p-4 space-y-4">
                <div class="bg-white p-6 rounded-[2rem] card-shadow border border-slate-100">
                    <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-4">åŠ¨ä½œåˆ—è¡¨ç®¡ç†</h3>
                    <div class="space-y-3">
                        <input type="text" id="lib-new-name" placeholder="åŠ¨ä½œåç§°" class="w-full bg-slate-50 border-0 rounded-xl px-4 py-3 text-[13px] font-bold outline-none">
                        <div class="flex gap-2">
                            <select id="lib-new-group" class="flex-1 bg-slate-50 border-0 rounded-xl px-4 py-3 text-[13px] font-bold outline-none">
                                <option>èƒ¸éƒ¨</option><option>èƒŒéƒ¨</option><option>è…¿éƒ¨</option><option>è‚©éƒ¨</option><option>æ‰‹è‡‚</option><option>æ ¸å¿ƒ</option><option>æœ‰æ°§</option>
                            </select>
                            <button onclick="addLibraryItem()" class="bg-slate-900 text-white px-6 py-3 rounded-xl text-[13px] font-black active:scale-95 transition-all">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
                <div id="lib-list" class="bg-white rounded-[2rem] card-shadow border border-slate-100 overflow-hidden divide-y divide-slate-50"></div>
            </div>

            <!-- è®¾ç½® -->
            <div id="tab-settings" class="tab-content p-4 space-y-4">
                <div class="bg-white rounded-[2rem] p-6 card-shadow border border-slate-100 space-y-6">
                    <div>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-3">ä¸ªæ€§åŒ–æ ‡è¯­</h3>
                        <textarea id="settings-banner" class="w-full bg-slate-50 p-4 rounded-xl text-[13px] font-bold outline-none border-0" rows="2"></textarea>
                        <button onclick="updateSettings()" class="mt-3 w-full bg-blue-600 text-white py-3 rounded-xl font-black text-[13px] active:scale-95">ä¿å­˜å¹¶æ›´æ–°</button>
                    </div>
                    <div class="pt-6 border-t border-slate-50 space-y-3">
                        <button onclick="exportMarkdown()" class="w-full p-4 bg-blue-50 text-blue-600 rounded-xl text-[12px] font-black flex justify-between items-center">
                            <span>å¯¼å‡º Markdown æ—¥å¿—</span>
                            <span>ğŸ“„</span>
                        </button>
                        <button onclick="clearData()" class="w-full p-4 bg-red-50 text-red-500 rounded-xl text-[12px] font-black">
                            æ¸…ç©ºæ‰€æœ‰æ•°æ®
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- ç¼–è¾‘é¢æ¿ -->
        <div id="editor-overlay" class="fixed inset-0 bg-white z-[100] hidden flex flex-col translate-y-full transition-transform duration-500">
            <div class="px-6 py-4 border-b flex justify-between items-center glass sticky top-0 z-10 header-pt">
                <button onclick="closeEditor(true)" class="text-slate-400 font-black text-[13px] px-2">å–æ¶ˆ</button>
                <h2 id="editor-title" class="font-black text-base text-slate-800">ç¼–è¾‘è®°å½•</h2>
                <button onclick="saveWorkout()" class="bg-blue-600 text-white px-6 py-2 rounded-full font-black text-[13px]">å®Œæˆ</button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-4 py-6 space-y-6 bg-slate-50/50 pb-32">
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">æ—¥æœŸ</label><input type="date" id="edit-date" class="w-full text-[13px] font-black outline-none bg-transparent" onchange="syncCurrentInputsToState()"></div>
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">å¿ƒæƒ…åé¦ˆ</label><select id="edit-mood" class="w-full text-[15px] font-black outline-none bg-transparent" onchange="syncCurrentInputsToState()"><option>ğŸ˜Š</option><option>ğŸ”¥</option><option>ğŸ˜´</option><option>ğŸ˜¤</option><option>ğŸ¤•</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">ä½“é‡ (KG)</label><input type="number" step="0.1" id="edit-weight" class="w-full text-[13px] font-black outline-none bg-transparent mono" placeholder="0.0" onchange="syncCurrentInputsToState()"></div>
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">ä½“è„‚ (%)</label><input type="number" step="0.1" id="edit-fat" class="w-full text-[13px] font-black outline-none bg-transparent mono" placeholder="0.0" onchange="syncCurrentInputsToState()"></div>
                </div>
                
                <div id="edit-exercises" class="space-y-4"></div>
                
                <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                    <h3 class="font-black text-slate-800 text-base mb-4">å¸¸ç”¨åŠ¨ä½œåº“</h3>
                    <div id="edit-lib-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
                
                <textarea id="edit-notes" placeholder="è®°å½•æ­¤åˆ»çš„å¿ƒæƒ…æˆ–å¤‡æ³¨..." class="w-full bg-white p-5 rounded-[1.5rem] border border-slate-100 min-h-[100px] text-[13px] font-bold outline-none" onchange="syncCurrentInputsToState()"></textarea>

                <button id="delete-log-btn" onclick="confirmDeleteCurrentLog()" class="w-full py-4 bg-white text-red-500 rounded-2xl font-black border border-red-50 text-[13px] hidden">
                    åˆ é™¤æœ¬æ¡è®°å½•
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="flex justify-around items-center bg-white/95 backdrop-blur-xl border-t border-slate-100 absolute bottom-0 w-full z-50">
            <button onclick="switchTab('home')" class="nav-btn active-nav flex-1 flex flex-col items-center gap-1 transition-all" data-tab="home">
                <div class="nav-text text-[17px] font-black">é¦–é¡µ</div>
                <div class="nav-dot w-1.5 h-1.5 bg-blue-600 rounded-full opacity-0 scale-0 transition-all"></div>
            </button>
            <button onclick="switchTab('calendar')" class="nav-btn flex-1 flex flex-col items-center gap-1 transition-all" data-tab="calendar">
                <div class="nav-text text-[17px] font-black">æ—¥å†</div>
                <div class="nav-dot w-1.5 h-1.5 bg-blue-600 rounded-full opacity-0 scale-0 transition-all"></div>
            </button>
            <button onclick="switchTab('stats')" class="nav-btn flex-1 flex flex-col items-center gap-1 transition-all" data-tab="stats">
                <div class="nav-text text-[17px] font-black">ç»Ÿè®¡</div>
                <div class="nav-dot w-1.5 h-1.5 bg-blue-600 rounded-full opacity-0 scale-0 transition-all"></div>
            </button>
            <button onclick="switchTab('library')" class="nav-btn flex-1 flex flex-col items-center gap-1 transition-all" data-tab="library">
                <div class="nav-text text-[17px] font-black">åŠ¨ä½œåº“</div>
                <div class="nav-dot w-1.5 h-1.5 bg-blue-600 rounded-full opacity-0 scale-0 transition-all"></div>
            </button>
            <button onclick="switchTab('settings')" class="nav-btn flex-1 flex flex-col items-center gap-1 transition-all" data-tab="settings">
                <div class="nav-text text-[17px] font-black">è®¾ç½®</div>
                <div class="nav-dot w-1.5 h-1.5 bg-blue-600 rounded-full opacity-0 scale-0 transition-all"></div>
            </button>
        </nav>
    </div>

    <script>
        const getLocalToday = () => {
            const d = new Date();
            return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().split('T')[0];
        };

        const INITIAL_LIB = [
            { id: '1', name: 'æ é“ƒå§æ¨', group: 'èƒ¸éƒ¨' }, { id: '2', name: 'å“‘é“ƒå§æ¨', group: 'èƒ¸éƒ¨' }, 
            { id: '3', name: 'ä¸Šæ–œå“‘é“ƒå§æ¨', group: 'èƒ¸éƒ¨' }, { id: '4', name: 'å™¨æ¢°å¤¹èƒ¸', group: 'èƒ¸éƒ¨' },
            { id: '5', name: 'åŒæ è‡‚å±ˆä¼¸', group: 'èƒ¸éƒ¨' },
            { id: '6', name: 'å¼•ä½“å‘ä¸Š', group: 'èƒŒéƒ¨' }, { id: '7', name: 'æ é“ƒåˆ’èˆ¹', group: 'èƒŒéƒ¨' }, 
            { id: '8', name: 'é«˜ä½ä¸‹æ‹‰', group: 'èƒŒéƒ¨' }, { id: '9', name: 'ä¼ ç»Ÿç¡¬æ‹‰', group: 'èƒŒéƒ¨' },
            { id: '10', name: 'å•è‡‚å“‘é“ƒåˆ’èˆ¹', group: 'èƒŒéƒ¨' },
            { id: '11', name: 'æ é“ƒæ·±è¹²', group: 'è…¿éƒ¨' }, { id: '12', name: 'è…¿ä¸¾', group: 'è…¿éƒ¨' }, 
            { id: '13', name: 'è…¿å±ˆä¼¸', group: 'è…¿éƒ¨' }, { id: '14', name: 'è…¿å¼¯ä¸¾', group: 'è…¿éƒ¨' },
            { id: '15', name: 'ä¿åŠ åˆ©äºšåˆ†è…¿è¹²', group: 'è…¿éƒ¨' },
            { id: '16', name: 'ç«™å§¿æ¨ä¸¾', group: 'è‚©éƒ¨' }, { id: '17', name: 'å“‘é“ƒä¾§å¹³ä¸¾', group: 'è‚©éƒ¨' },
            { id: '18', name: 'å“‘é“ƒå‰å¹³ä¸¾', group: 'è‚©éƒ¨' }, { id: '19', name: 'ç»³ç´¢é¢æ‹‰', group: 'è‚©éƒ¨' },
            { id: '20', name: 'å“‘é“ƒå¼¯ä¸¾', group: 'æ‰‹è‡‚' }, { id: '21', name: 'æ é“ƒå¼¯ä¸¾', group: 'æ‰‹è‡‚' },
            { id: '22', name: 'ç»³ç´¢ä¸‹å‹', group: 'æ‰‹è‡‚' }, { id: '23', name: 'ç¢å¤´è€…', group: 'æ‰‹è‡‚' },
            { id: '24', name: 'æ‚¬å‚ä¸¾è…¿', group: 'æ ¸å¿ƒ' }, { id: '25', name: 'å·è…¹', group: 'æ ¸å¿ƒ' },
            { id: '26', name: 'å¹³æ¿æ”¯æ’‘', group: 'æ ¸å¿ƒ' },
            { id: '27', name: 'è·‘æ­¥æœº', group: 'æœ‰æ°§' }, { id: '28', name: 'æ¤­åœ†æœº', group: 'æœ‰æ°§' },
            { id: '29', name: 'åŠ¨æ„Ÿå•è½¦', group: 'æœ‰æ°§' }, { id: '30', name: 'åˆ’èˆ¹æœº', group: 'æœ‰æ°§' }
        ];

        let appState = {
            logs: JSON.parse(localStorage.getItem('fitlog_v2_data') || '[]'),
            library: JSON.parse(localStorage.getItem('fitlog_lib_v2') || JSON.stringify(INITIAL_LIB)),
            banner: localStorage.getItem('fitlog_banner') || 'è®°å½•èœ•å˜ï¼Œè§è¯æ›´å¼ºçš„è‡ªå·±ï¼'
        };

        const COLORS = { 'èƒ¸éƒ¨': '#3b82f6', 'èƒŒéƒ¨': '#10b981', 'è…¿éƒ¨': '#8b5cf6', 'è‚©éƒ¨': '#f59e0b', 'æ‰‹è‡‚': '#ec4899', 'æ ¸å¿ƒ': '#ef4444', 'æœ‰æ°§': '#06b6d4' };
        let currentMonth = new Date();
        let currentEditLog = null;
        let charts = { sbd: null, weight: null, fat: null, volume: null };

        function init() {
            document.getElementById('header-banner').textContent = appState.banner;
            document.getElementById('settings-banner').value = appState.banner;
            renderHome();
        }

        function addLibraryItem() {
            const name = document.getElementById('lib-new-name').value.trim();
            const group = document.getElementById('lib-new-group').value;
            if(!name) return;
            appState.library.push({ id: Date.now().toString(), name, group });
            localStorage.setItem('fitlog_lib_v2', JSON.stringify(appState.library));
            renderLibrary();
            document.getElementById('lib-new-name').value = '';
        }

        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = appState.library.map(item => `
                <div class="flex items-center justify-between p-4 bg-white hover:bg-slate-50 transition-colors">
                    <div class="flex items-center gap-3">
                        <div class="w-2.5 h-2.5 rounded-full" style="background:${COLORS[item.group] || '#ddd'}"></div>
                        <div class="text-[14px] font-black text-slate-800">${item.name}</div>
                    </div>
                    <button onclick="deleteLibItem('${item.id}')" class="text-slate-200 text-xl font-bold px-2">Ã—</button>
                </div>
            `).join('');
        }

        window.deleteLibItem = (id) => {
            if(!confirm('ç¡®å®šç§»é™¤æ­¤åŠ¨ä½œï¼Ÿ')) return;
            appState.library = appState.library.filter(i => i.id !== id);
            localStorage.setItem('fitlog_lib_v2', JSON.stringify(appState.library));
            renderLibrary();
        };

        function syncCurrentInputsToState() {
            if (!currentEditLog) return;
            currentEditLog.date = document.getElementById('edit-date').value;
            currentEditLog.mood = document.getElementById('edit-mood').value;
            currentEditLog.weight = parseFloat(document.getElementById('edit-weight').value) || null;
            currentEditLog.bodyFat = parseFloat(document.getElementById('edit-fat').value) || null;
            currentEditLog.notes = document.getElementById('edit-notes').value;
        }

        window.openEditor = (id = null) => {
            const overlay = document.getElementById('editor-overlay');
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.style.transform = 'translateY(0)', 10);
            
            const deleteBtn = document.getElementById('delete-log-btn');
            if(id) {
                currentEditLog = JSON.parse(JSON.stringify(appState.logs.find(l => l.id === id)));
                deleteBtn.classList.remove('hidden');
            } else {
                currentEditLog = { id: Date.now().toString(), date: getLocalToday(), exercises: [], mood: 'ğŸ˜Š', weight: null, bodyFat: null, notes: '' };
                deleteBtn.classList.add('hidden');
            }
            
            document.getElementById('edit-date').value = currentEditLog.date;
            document.getElementById('edit-mood').value = currentEditLog.mood;
            document.getElementById('edit-weight').value = currentEditLog.weight || '';
            document.getElementById('edit-fat').value = currentEditLog.bodyFat || '';
            document.getElementById('edit-notes').value = currentEditLog.notes;
            syncEditorUI();
        };

        window.closeEditor = (confirmCancel) => {
            if(confirmCancel && currentEditLog.exercises.length > 0 && !confirm('æ”¾å¼ƒå½“å‰ç¼–è¾‘ï¼Ÿ')) return;
            const overlay = document.getElementById('editor-overlay');
            overlay.style.transform = 'translateY(100%)';
            setTimeout(() => overlay.classList.add('hidden'), 500);
        };

        function syncEditorUI() {
            const list = document.getElementById('edit-exercises');
            list.innerHTML = currentEditLog.exercises.map((ex, exIdx) => `
                <div class="bg-white rounded-[1.5rem] p-5 border-l-[8px] shadow-sm relative" style="border-color:${COLORS[ex.group] || '#ddd'}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-black text-[14px] text-slate-800">${ex.name}</span>
                        <button onclick="removeEx(${exIdx})" class="text-red-400 font-black text-[11px] uppercase">ç§»é™¤</button>
                    </div>
                    <div class="space-y-2">
                        ${ex.sets.map((s, sIdx) => `
                            <div class="grid grid-cols-4 gap-2 items-center">
                                <span class="bg-slate-50 text-slate-500 font-black h-10 flex items-center justify-center rounded-xl mono text-[12px]">${sIdx+1}</span>
                                <input type="number" step="0.5" value="${s.weight}" class="bg-slate-50 h-10 text-center rounded-xl font-black mono outline-none text-[13px]" onchange="updateSetData(${exIdx},${sIdx},'weight',this.value)">
                                <input type="number" step="1" value="${s.reps}" class="bg-slate-50 h-10 text-center rounded-xl font-black mono outline-none text-[13px]" onchange="updateSetData(${exIdx},${sIdx},'reps',this.value)">
                                <button onclick="removeSet(${exIdx},${sIdx})" class="text-slate-200 text-2xl font-bold">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addSet(${exIdx})" class="w-full mt-4 py-2.5 bg-slate-50 text-[11px] font-black rounded-xl border border-dashed border-slate-200 text-slate-400">+ æ–°ç»„æ¬¡</button>
                </div>
            `).join('');

            const grid = document.getElementById('edit-lib-grid');
            grid.innerHTML = appState.library.map(item => `
                <button onclick="quickAddEx('${item.id}')" class="p-3 bg-white rounded-xl text-[12px] font-black border border-slate-100 shadow-sm text-left active:scale-95 transition-all">
                    <div class="text-[9px] opacity-30 uppercase mb-0.5" style="color:${COLORS[item.group]}">${item.group}</div>
                    <div class="truncate text-slate-700">${item.name}</div>
                </button>
            `).join('');
        }

        window.updateSetData = (exIdx, sIdx, field, val) => { currentEditLog.exercises[exIdx].sets[sIdx][field] = parseFloat(val) || 0; };
        window.addSet = (idx) => { 
            syncCurrentInputsToState();
            const ex = currentEditLog.exercises[idx];
            const last = ex.sets[ex.sets.length - 1];
            ex.sets.push({ weight: last ? last.weight : 0, reps: last ? last.reps : 0 });
            syncEditorUI();
        };
        window.removeSet = (exIdx, sIdx) => { 
            syncCurrentInputsToState();
            if(currentEditLog.exercises[exIdx].sets.length > 1) { currentEditLog.exercises[exIdx].sets.splice(sIdx, 1); syncEditorUI(); } 
        };
        window.removeEx = (idx) => { syncCurrentInputsToState(); currentEditLog.exercises.splice(idx, 1); syncEditorUI(); };
        window.quickAddEx = (libId) => {
            syncCurrentInputsToState();
            const item = appState.library.find(i => i.id === libId);
            currentEditLog.exercises.push({ ...item, sets: [{ weight: 0, reps: 0 }] });
            syncEditorUI();
        };

        window.saveWorkout = () => {
            syncCurrentInputsToState();
            if(!currentEditLog.exercises.length) return alert('è¯·è‡³å°‘è®°å½•ä¸€ä¸ªåŠ¨ä½œ');
            const idx = appState.logs.findIndex(l => l.id === currentEditLog.id);
            if(idx > -1) appState.logs[idx] = currentEditLog; else appState.logs.push(currentEditLog);
            localStorage.setItem('fitlog_v2_data', JSON.stringify(appState.logs));
            renderHome(); closeEditor(false);
        };

        window.confirmDeleteCurrentLog = () => {
            if(!confirm('ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ')) return;
            appState.logs = appState.logs.filter(l => l.id !== currentEditLog.id);
            localStorage.setItem('fitlog_v2_data', JSON.stringify(appState.logs));
            renderHome(); closeEditor(false);
        };

        function calculateLogVolume(log) {
            return log.exercises.reduce((acc, ex) => {
                return acc + ex.sets.reduce((sAcc, s) => sAcc + (s.weight * s.reps), 0);
            }, 0);
        }

        function renderHome() {
            const list = document.getElementById('log-list');
            const sorted = [...appState.logs].sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('stat-total').textContent = sorted.length;
            const now = new Date();
            document.getElementById('stat-month').textContent = sorted.filter(l => {
                const d = new Date(l.date.replace(/-/g, '/'));
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length;

            if(!sorted.length) {
                list.innerHTML = '<div class="py-20 text-center text-slate-300 font-bold italic">æ²¡æœ‰è®°å½•</div>';
                return;
            }

            list.innerHTML = sorted.map(log => `
                <div class="bg-white rounded-[1.5rem] p-6 card-shadow border border-slate-50 space-y-4">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl leading-none">${log.mood || 'ğŸ˜Š'}</span>
                            <div>
                                <h3 class="font-black text-[14px] text-slate-800">${log.date}</h3>
                                <p class="text-[10px] font-black text-slate-300 tracking-widest mt-0.5 uppercase">å®¹é‡: ${calculateLogVolume(log)}kg | ${log.weight || '--'}kg</p>
                            </div>
                        </div>
                        <button onclick="openEditor('${log.id}')" class="px-4 py-1.5 text-blue-600 font-black text-[11px] bg-blue-50 rounded-full">ç¼–è¾‘</button>
                    </div>

                    ${log.notes ? `
                        <div class="bg-slate-50/50 p-3 rounded-xl border-l-4 border-slate-200">
                            <p class="text-[11px] text-slate-500 font-medium leading-relaxed italic">"${log.notes}"</p>
                        </div>
                    ` : ''}

                    <div class="space-y-2">
                        ${log.exercises.map(ex => `
                            <div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between">
                                <div class="flex-1">
                                    <div class="text-[13px] font-black text-slate-800">${ex.name}</div>
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${ex.sets.map(s => `<span class="bg-white px-1.5 py-0.5 rounded-lg border border-slate-200 text-[10px] font-black mono text-slate-500">${s.weight}Ã—${s.reps}</span>`).join('')}
                                    </div>
                                </div>
                                <span class="text-[9px] font-black px-1.5 py-0.5 rounded-full text-white shrink-0" style="background:${COLORS[ex.group] || '#ddd'}">${ex.group}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-nav'));
            document.querySelector(`[data-tab="${id}"]`).classList.add('active-nav');
            if(id === 'calendar') renderCalendar();
            if(id === 'stats') renderStats();
            if(id === 'library') renderLibrary();
        };

        function renderStats() {
            const logs = [...appState.logs].sort((a,b) => new Date(a.date) - new Date(b.date));
            const prs = { s: 0, b: 0, d: 0 };
            logs.forEach(l => l.exercises.forEach(ex => {
                const max = Math.max(...ex.sets.map(s => s.weight));
                if(ex.name.includes('æ·±è¹²')) prs.s = Math.max(prs.s, max);
                if(ex.name.includes('å§æ¨')) prs.b = Math.max(prs.b, max);
                if(ex.name.includes('ç¡¬æ‹‰')) prs.d = Math.max(prs.d, max);
            }));
            document.getElementById('pr-squat').textContent = prs.s || '--';
            document.getElementById('pr-bench').textContent = prs.b || '--';
            document.getElementById('pr-deadlift').textContent = prs.d || '--';

            const recent = logs.slice(-12);
            const labels = recent.map(l => l.date.slice(5));

            // å®¹é‡å›¾è¡¨
            if(charts.volume) charts.volume.destroy();
            charts.volume = new Chart(document.getElementById('volume-chart'), {
                type: 'bar',
                data: { labels, datasets: [{ label: 'å®¹é‡', data: recent.map(l => calculateLogVolume(l)), backgroundColor: 'rgba(59, 130, 246, 0.4)', borderRadius: 8 }] },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });

            if(charts.sbd) charts.sbd.destroy();
            charts.sbd = new Chart(document.getElementById('sbd-chart'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'è¹²', data: recent.map(l => { const e = l.exercises.find(e => e.name.includes('æ·±è¹²')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; }), borderColor: '#ef4444', tension: 0.4, spanGaps: true },
                    { label: 'æ¨', data: recent.map(l => { const e = l.exercises.find(e => e.name.includes('å§æ¨')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; }), borderColor: '#3b82f6', tension: 0.4, spanGaps: true },
                    { label: 'æ‹‰', data: recent.map(l => { const e = l.exercises.find(e => e.name.includes('ç¡¬æ‹‰')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; }), borderColor: '#1e293b', tension: 0.4, spanGaps: true }
                ] }
            });

            if(charts.weight) charts.weight.destroy();
            charts.weight = new Chart(document.getElementById('weight-chart'), {
                type: 'line',
                data: { labels, datasets: [{ data: recent.map(l => l.weight), borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 }] },
                options: { plugins: { legend: { display: false } } }
            });

            if(charts.fat) charts.fat.destroy();
            charts.fat = new Chart(document.getElementById('fat-chart'), {
                type: 'line',
                data: { labels, datasets: [{ data: recent.map(l => l.bodyFat), borderColor: '#ec4899', backgroundColor: 'rgba(236, 72, 153, 0.1)', fill: true, tension: 0.4 }] },
                options: { plugins: { legend: { display: false } } }
            });
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-days'); grid.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            const names = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];
            document.getElementById('calendar-title').innerHTML = `${y}å¹´ ${names[m]}`;
            const first = new Date(y, m, 1).getDay();
            const daysCount = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=daysCount; d++) {
                const dayDiv = document.createElement('div');
                const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const dayLogs = appState.logs.filter(l => l.date === iso);
                const hasLog = dayLogs.length > 0;
                
                // æ‰¾å‡ºä¸»ç»ƒéƒ¨ä½
                let mainGroup = "";
                if (hasLog) {
                    const groupCounts = {};
                    dayLogs.forEach(log => log.exercises.forEach(ex => {
                        groupCounts[ex.group] = (groupCounts[ex.group] || 0) + 1;
                    }));
                    mainGroup = Object.entries(groupCounts).sort((a,b) => b[1] - a[1])[0][0];
                }

                dayDiv.className = `flex flex-col items-center justify-start min-h-[50px] py-1 rounded-xl cursor-pointer transition-all ${hasLog ? 'bg-slate-50 border border-slate-100 shadow-sm' : 'hover:bg-slate-50'}`;
                dayDiv.innerHTML = `
                    <span class="text-[12px] font-black ${hasLog ? 'text-blue-600' : 'text-slate-400'}">${d}</span>
                    ${hasLog ? `
                        <div class="mt-1 w-full px-1 flex flex-col items-center gap-0.5">
                            <div class="w-2 h-2 rounded-full" style="background:${COLORS[mainGroup]}"></div>
                            <span class="text-[8px] font-bold text-slate-400 scale-90 whitespace-nowrap">${calculateLogVolume(dayLogs[0])}kg</span>
                        </div>
                    ` : ''}
                `;
                dayDiv.onclick = () => {
                    const detail = document.getElementById('calendar-detail');
                    detail.innerHTML = dayLogs.length ? dayLogs.map(log => `
                        <div class="bg-white p-5 rounded-2xl mt-3 shadow-sm flex justify-between items-center group active:scale-95 transition-all">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">${log.mood || 'ğŸ˜Š'}</span>
                                <div>
                                    <div class="font-black text-slate-800 text-[14px]">${log.date} è®­ç»ƒæ—¥</div>
                                    <div class="text-[10px] font-bold text-slate-400 uppercase mt-0.5">ä¸»ç»ƒéƒ¨ä½: ${mainGroup} | å®¹é‡: ${calculateLogVolume(log)}kg</div>
                                </div>
                            </div>
                            <button onclick="openEditor('${log.id}')" class="bg-blue-50 px-4 py-2 rounded-xl text-blue-600 font-black text-[11px]">æŸ¥çœ‹è¯¦æƒ…</button>
                        </div>
                    `).join('') : '<div class="p-10 text-center text-slate-300 text-[12px] italic">ä»Šæ—¥ç»™è‡ªå·±æ”¾äº†ä¸ªå‡ ğŸ’¤</div>';
                };
                grid.appendChild(dayDiv);
            }
        }
        window.changeMonth = (dir) => { currentMonth.setMonth(currentMonth.getMonth()+dir); renderCalendar(); };

        window.updateSettings = () => { 
            appState.banner = document.getElementById('settings-banner').value; 
            localStorage.setItem('fitlog_banner', appState.banner); 
            document.getElementById('header-banner').textContent = appState.banner;
            alert('æ ‡è¯­æ›´æ–°æˆåŠŸ âœ¨');
        };

        window.exportMarkdown = () => {
            let md = "# FitLog è®­ç»ƒæ—¥å¿—å¯¼å‡º\n\n";
            [...appState.logs].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
                md += `## ${l.date} ${l.mood}\n- æ€»å®¹é‡: ${calculateLogVolume(l)}kg\n- ä½“é‡: ${l.weight || '--'}kg / ä½“è„‚: ${l.bodyFat || '--'}%\n`;
                l.exercises.forEach(ex => {
                    md += `### ${ex.name} (${ex.group})\n`;
                    ex.sets.forEach((s, i) => md += `- ç»„${i+1}: ${s.weight}kg x ${s.reps}æ¬¡\n`);
                });
                if(l.notes) md += `\n> ğŸ“ å¤‡æ³¨: ${l.notes}\n`;
                md += `\n---\n\n`;
            });
            const blob = new Blob([md], {type:'text/markdown'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = `FitLog_Export_${getLocalToday()}.md`; a.click();
        };

        window.clearData = () => { if(confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) { localStorage.clear(); location.reload(); } };

        init();
    </script>
</body>
</html>
