
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLog | æ‚¦åŠ¨è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .active-nav { color: #2563eb; font-weight: 700; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="text-slate-900 overflow-hidden">
    <div class="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-2xl relative overflow-hidden">
        
        <!-- Header -->
        <header class="px-6 py-4 border-b border-slate-100 bg-white z-10">
            <div class="flex justify-between items-center mb-1">
                <h1 class="text-2xl font-black bg-gradient-to-r from-blue-600 to-orange-500 bg-clip-text text-transparent">FitLog</h1>
                <span id="header-date" class="text-[10px] font-black text-slate-300 uppercase tracking-widest"></span>
            </div>
            <p id="header-banner" class="text-[11px] text-slate-400 font-medium italic truncate">è®°å½•æ¯ä¸€æ¬¡èœ•å˜</p>
        </header>

        <!-- Main Content Area -->
        <main id="main-scroll" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 pb-20">
            
            <!-- Tab: Dashboard -->
            <div id="tab-home" class="tab-content active p-4 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-600 rounded-3xl p-5 text-white card-shadow">
                        <div id="stat-total" class="text-3xl font-black">0</div>
                        <div class="text-[10px] opacity-80 font-black uppercase">ç´¯è®¡è®­ç»ƒ</div>
                    </div>
                    <div class="bg-orange-500 rounded-3xl p-5 text-white card-shadow">
                        <div id="stat-month" class="text-3xl font-black">0</div>
                        <div class="text-[10px] opacity-80 font-black uppercase">æœ¬æœˆè®°å½•</div>
                    </div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-lg font-black text-slate-800 flex items-center gap-2">
                        <div class="w-1.5 h-5 bg-blue-600 rounded-full"></div>åŠ¨æ€è¯¦æƒ…
                    </h2>
                    <button onclick="openEditor()" class="text-xs font-bold text-blue-600 bg-blue-50 px-4 py-2 rounded-full">å¼€å§‹è®°å½•</button>
                </div>
                <div id="log-list" class="space-y-4"></div>
            </div>

            <!-- Tab: Calendar -->
            <div id="tab-calendar" class="tab-content p-4 space-y-4">
                <div class="bg-white rounded-3xl p-6 border border-slate-100 card-shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="calendar-title" class="text-xl font-black text-slate-800">2024 <span class="text-blue-600">åæœˆ</span></h2>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="p-2 text-slate-400">ä¸Šæœˆ</button>
                            <button onclick="changeMonth(1)" class="p-2 text-slate-400">ä¸‹æœˆ</button>
                        </div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
                </div>
                <div id="calendar-detail" class="hidden animate-in fade-in slide-in-from-bottom-4 duration-300"></div>
            </div>

            <!-- Tab: Stats -->
            <div id="tab-stats" class="tab-content p-4 space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-red-50 p-3 rounded-2xl text-center border border-red-100">
                        <div class="text-[10px] font-bold text-red-400">æ·±è¹² PR</div>
                        <div id="pr-squat" class="text-lg font-black text-red-600">--</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-2xl text-center border border-blue-100">
                        <div class="text-[10px] font-bold text-blue-400">å§æ¨ PR</div>
                        <div id="pr-bench" class="text-lg font-black text-blue-600">--</div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-2xl text-center border border-slate-200">
                        <div class="text-[10px] font-bold text-slate-400">ç¡¬æ‹‰ PR</div>
                        <div id="pr-deadlift" class="text-lg font-black text-slate-800">--</div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-5 card-shadow">
                    <h3 class="text-sm font-bold mb-4">SBD é‡é‡è¶‹åŠ¿</h3>
                    <canvas id="sbd-chart" height="200"></canvas>
                </div>
                <div class="bg-white rounded-3xl p-5 card-shadow">
                    <h3 class="text-sm font-bold mb-4">èº«ä½“æŒ‡æ ‡è¶‹åŠ¿</h3>
                    <canvas id="body-chart" height="200"></canvas>
                </div>
            </div>

            <!-- Tab: Library -->
            <div id="tab-library" class="tab-content p-4 space-y-4">
                <input type="text" id="lib-search" placeholder="æœç´¢ 50+ åŠ¨ä½œåº“..." class="w-full p-4 rounded-2xl bg-white card-shadow border-0 text-sm" oninput="renderLibrary()">
                <div id="lib-groups" class="flex gap-2 overflow-x-auto no-scrollbar pb-2"></div>
                <div id="lib-list" class="bg-white rounded-3xl p-2 card-shadow space-y-1"></div>
            </div>

            <!-- Tab: Settings -->
            <div id="tab-settings" class="tab-content p-4 space-y-6">
                <div class="bg-white rounded-3xl p-6 card-shadow">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">ä¸ªæ€§åŒ–</h3>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Banner åè¨€</label>
                    <textarea id="settings-banner" class="w-full bg-slate-50 rounded-2xl p-4 text-xs text-slate-600" onchange="updateSettings()"></textarea>
                </div>
                <div class="bg-white rounded-3xl p-6 card-shadow space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase mb-4">æ•°æ®ç®¡ç†</h3>
                    <button onclick="exportMarkdown()" class="w-full p-4 bg-slate-50 rounded-2xl text-sm font-bold text-slate-700 flex justify-between items-center">
                        <span>å¯¼å‡º Markdown æ•°æ®</span>
                        <span class="text-blue-600">ä¸‹è½½</span>
                    </button>
                    <button onclick="clearData()" class="w-full p-4 bg-red-50 rounded-2xl text-sm font-bold text-red-600">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </main>

        <!-- Editor Overlay -->
        <div id="editor-overlay" class="fixed inset-0 bg-white z-50 hidden flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <button onclick="closeEditor(true)" class="text-slate-400 px-2 py-1 text-sm">æ”¾å¼ƒ</button>
                <h2 class="font-bold text-slate-800">è®­ç»ƒè®°å½•</h2>
                <button onclick="saveWorkout()" class="bg-blue-600 text-white px-6 py-2 rounded-full text-sm font-bold">å®Œæˆ</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-2xl card-shadow"><label class="text-[10px] text-slate-400 block mb-1">æ—¥æœŸ</label><input type="date" id="edit-date" class="w-full text-sm font-bold outline-none"></div>
                    <div class="bg-white p-3 rounded-2xl card-shadow"><label class="text-[10px] text-slate-400 block mb-1">å¿ƒæƒ…</label><select id="edit-mood" class="w-full text-base outline-none bg-transparent"><option>ğŸ˜Š</option><option>ğŸ”¥</option><option>ğŸ˜´</option><option>ğŸ˜¤</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-2xl card-shadow"><label class="text-[10px] text-slate-400 block mb-1">ä½“é‡ (KG)</label><input type="number" step="0.1" id="edit-weight" class="w-full text-sm font-bold outline-none" placeholder="0.0"></div>
                    <div class="bg-white p-3 rounded-2xl card-shadow"><label class="text-[10px] text-slate-400 block mb-1">ä½“è„‚ (%)</label><input type="number" step="0.1" id="edit-fat" class="w-full text-sm font-bold outline-none" placeholder="0.0"></div>
                </div>
                <div id="edit-exercises" class="space-y-4"></div>
                <div class="bg-white p-4 rounded-3xl card-shadow"><textarea id="edit-notes" placeholder="è®­ç»ƒç¬”è®°..." class="w-full text-sm outline-none min-h-[80px]"></textarea></div>
                <div class="bg-white rounded-3xl p-5 border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4">å¿«é€Ÿæ·»åŠ åŠ¨ä½œ</h3>
                    <div id="edit-lib-grid" class="grid grid-cols-2 gap-2"></div>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <nav class="flex justify-around items-center py-3 bg-white border-t border-slate-100 shadow-[0_-2px_10px_rgba(0,0,0,0.05)] absolute bottom-0 w-full">
            <button onclick="switchTab('home')" class="nav-btn active-nav flex flex-col items-center gap-1" data-tab="home"><span class="text-xs font-bold">é¦–é¡µ</span></button>
            <button onclick="switchTab('calendar')" class="nav-btn flex flex-col items-center gap-1" data-tab="calendar"><span class="text-xs font-bold">æ—¥å†</span></button>
            <button onclick="switchTab('stats')" class="nav-btn flex flex-col items-center gap-1" data-tab="stats"><span class="text-xs font-bold">ç»Ÿè®¡</span></button>
            <button onclick="switchTab('library')" class="nav-btn flex flex-col items-center gap-1" data-tab="library"><span class="text-xs font-bold">åº“</span></button>
            <button onclick="switchTab('settings')" class="nav-btn flex flex-col items-center gap-1" data-tab="settings"><span class="text-xs font-bold">è®¾ç½®</span></button>
        </nav>
    </div>

    <script type="module">
        // --- é™æ€æ•°æ®: 50+ åŠ¨ä½œ ---
        const DEFAULT_EXERCISES = [
            { id: 'c1', name: 'æ é“ƒå¹³å§æ¨', group: 'èƒ¸' }, { id: 'c2', name: 'å“‘é“ƒä¸Šæ–œå§æ¨', group: 'èƒ¸' }, { id: 'c3', name: 'ç»³ç´¢å¤¹èƒ¸', group: 'èƒ¸' }, { id: 'c4', name: 'è´è¶æœºå¤¹èƒ¸', group: 'èƒ¸' }, { id: 'c5', name: 'åŒæ è‡‚å±ˆä¼¸', group: 'èƒ¸' },
            { id: 's1', name: 'ç«™å§¿æ é“ƒæ¨ä¸¾', group: 'è‚©' }, { id: 's2', name: 'åå§¿å“‘é“ƒæ¨ä¸¾', group: 'è‚©' }, { id: 's3', name: 'å“‘é“ƒä¾§å¹³ä¸¾', group: 'è‚©' }, { id: 's4', name: 'åå‘è´è¶æœº', group: 'è‚©' }, { id: 's5', name: 'é¢æ‹‰', group: 'è‚©' },
            { id: 'b1', name: 'å¼•ä½“å‘ä¸Š', group: 'èƒŒ' }, { id: 'b2', name: 'é«˜ä½ä¸‹æ‹‰', group: 'èƒŒ' }, { id: 'b3', name: 'æ é“ƒåˆ’èˆ¹', group: 'èƒŒ' }, { id: 'b4', name: 'å•è‡‚å“‘é“ƒåˆ’èˆ¹', group: 'èƒŒ' }, { id: 'b5', name: 'åå§¿åˆ’èˆ¹', group: 'èƒŒ' },
            { id: 'l1', name: 'æ é“ƒæ·±è¹²', group: 'è…¿' }, { id: 'l2', name: 'ç¡¬æ‹‰', group: 'è…¿' }, { id: 'l3', name: 'è…¿ä¸¾', group: 'è…¿' }, { id: 'l4', name: 'è…¿å±ˆä¼¸', group: 'è…¿' }, { id: 'l5', name: 'ä¿åŠ åˆ©äºšåˆ†è…¿è¹²', group: 'è…¿' },
            { id: 'a1', name: 'æ é“ƒå¼¯ä¸¾', group: 'èƒ³è†Š' }, { id: 'a2', name: 'å“‘é“ƒé”¤å¼å¼¯ä¸¾', group: 'èƒ³è†Š' }, { id: 'a3', name: 'ç»³ç´¢ä¸‹å‹', group: 'èƒ³è†Š' }, { id: 'a4', name: 'çª„è·å§æ¨', group: 'èƒ³è†Š' },
            { id: 'h1', name: 'å·è…¹', group: 'æ ¸å¿ƒ' }, { id: 'h2', name: 'å¹³æ¿æ”¯æ’‘', group: 'æ ¸å¿ƒ' }, { id: 'h3', name: 'æ‚¬å‚ä¸¾è…¿', group: 'æ ¸å¿ƒ' },
            { id: 'o1', name: 'è·‘æ­¥æœºè·‘æ­¥', group: 'æœ‰æ°§' }, { id: 'o2', name: 'åŠ¨æ„Ÿå•è½¦', group: 'æœ‰æ°§' }, { id: 'o3', name: 'è·³ç»³', group: 'æœ‰æ°§' }
        ];
        // è¡¥è¶³è‡³50ä¸ª
        for(let i=1; i<=20; i++) DEFAULT_EXERCISES.push({ id: 'ext'+i, name: 'è¿›é˜¶åŠ¨ä½œ'+i, group: ['èƒ¸','è‚©','èƒŒ','è…¿','èƒ³è†Š','æ ¸å¿ƒ','æœ‰æ°§'][i%7] });

        const GROUP_COLORS = { 'èƒ¸': '#3b82f6', 'è‚©': '#f97316', 'èƒŒ': '#10b981', 'è…¿': '#8b5cf6', 'èƒ³è†Š': '#ec4899', 'æ ¸å¿ƒ': '#f59e0b', 'æœ‰æ°§': '#06b6d4' };

        // --- çŠ¶æ€ç®¡ç† ---
        let appState = {
            logs: JSON.parse(localStorage.getItem('fitlog_v1_data') || '[]'),
            banner: localStorage.getItem('fitlog_banner') || 'æ¯ä¸€ä¸ªä¼Ÿå¤§çš„å˜åŒ–ï¼Œéƒ½æºè‡ªåšæŒä¸æ‡ˆçš„è®°å½•ã€‚'
        };
        let currentMonth = new Date();
        let currentEditLog = null;

        // --- åˆå§‹åŒ– ---
        function init() {
            document.getElementById('header-date').textContent = new Date().toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            document.getElementById('header-banner').textContent = appState.banner;
            document.getElementById('settings-banner').value = appState.banner;
            renderHome();
            renderLibrary();
        }

        // --- è·¯ç”±åˆ‡æ¢ ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-nav'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active-nav');
            if(tabId === 'calendar') renderCalendar();
            if(tabId === 'stats') renderStats();
            document.getElementById('main-scroll').scrollTop = 0;
        };

        // --- é¦–é¡µæ¨¡å— ---
        function renderHome() {
            const list = document.getElementById('log-list');
            list.innerHTML = '';
            appState.logs.sort((a,b) => new Date(b.date) - new Date(a.date));
            
            document.getElementById('stat-total').textContent = appState.logs.length;
            document.getElementById('stat-month').textContent = appState.logs.filter(l => new Date(l.date).getMonth() === new Date().getMonth()).length;

            appState.logs.forEach(log => {
                const item = document.createElement('div');
                item.className = 'bg-white rounded-[2rem] p-6 card-shadow border border-slate-100 space-y-4';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">${log.mood}</span>
                            <div>
                                <h3 class="font-black text-slate-800">${new Date(log.date).toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' })}</h3>
                                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${log.weight ? log.weight + 'KG' : '--'} / ${log.bodyFat ? log.bodyFat + '%' : '--'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditor('${log.id}')" class="text-blue-500 font-bold text-xs">ç¼–è¾‘</button>
                            <button onclick="deleteLog('${log.id}')" class="text-red-300 font-bold text-xs">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        ${log.exercises.map(ex => `
                            <div class="bg-slate-50/50 rounded-xl p-2 border border-slate-100">
                                <span class="text-[10px] font-black" style="color:${GROUP_COLORS[ex.group]}">${ex.name}</span>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${ex.sets.map(s => `<span class="text-[10px] bg-white px-1.5 py-0.5 rounded border border-slate-100">${s.weight}kg/${s.reps}æ¬¡</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- ç¼–è¾‘å™¨æ¨¡å— ---
        window.openEditor = (logId = null) => {
            document.getElementById('editor-overlay').classList.remove('hidden');
            if(logId) {
                currentEditLog = JSON.parse(JSON.stringify(appState.logs.find(l => l.id === logId)));
            } else {
                currentEditLog = { id: Date.now().toString(), date: new Date().toISOString().split('T')[0], exercises: [], mood: 'ğŸ˜Š', weight: null, bodyFat: null, notes: '' };
            }
            syncEditorUI();
        };

        window.closeEditor = (confirmCancel) => {
            if(confirmCancel && !confirm('æ”¾å¼ƒå½“å‰è®°å½•ï¼Ÿ')) return;
            document.getElementById('editor-overlay').classList.add('hidden');
        };

        function syncEditorUI() {
            document.getElementById('edit-date').value = currentEditLog.date.split('T')[0];
            document.getElementById('edit-mood').value = currentEditLog.mood;
            document.getElementById('edit-weight').value = currentEditLog.weight || '';
            document.getElementById('edit-fat').value = currentEditLog.bodyFat || '';
            document.getElementById('edit-notes').value = currentEditLog.notes || '';
            
            const list = document.getElementById('edit-exercises');
            list.innerHTML = '';
            currentEditLog.exercises.forEach((ex, exIdx) => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-2xl p-4 card-shadow border-l-4';
                div.style.borderColor = GROUP_COLORS[ex.group];
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-slate-800">${ex.name}</span>
                        <button onclick="removeEx(${exIdx})" class="text-red-400 text-xs">ç§»é™¤</button>
                    </div>
                    <div class="space-y-2">
                        ${ex.sets.map((s, sIdx) => `
                            <div class="flex gap-2 items-center">
                                <span class="text-[10px] w-4">${sIdx+1}</span>
                                <input type="number" value="${s.weight}" class="flex-1 bg-slate-50 p-1 text-center rounded text-sm" onchange="updateSet(${exIdx}, ${sIdx}, 'weight', this.value)">
                                <span class="text-[10px]">KG</span>
                                <input type="number" value="${s.reps}" class="flex-1 bg-slate-50 p-1 text-center rounded text-sm" onchange="updateSet(${exIdx}, ${sIdx}, 'reps', this.value)">
                                <span class="text-[10px]">æ¬¡</span>
                                <button onclick="removeSet(${exIdx}, ${sIdx})" class="text-slate-300">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addSet(${exIdx})" class="w-full mt-3 py-1 bg-slate-50 text-[10px] text-slate-400 font-bold rounded">+ åŠ ç»„</button>
                `;
                list.appendChild(div);
            });

            // ç¼–è¾‘å™¨å†…çš„åŠ¨ä½œåº“
            const libGrid = document.getElementById('edit-lib-grid');
            libGrid.innerHTML = '';
            DEFAULT_EXERCISES.slice(0, 10).forEach(ex => {
                const btn = document.createElement('button');
                btn.className = 'p-2 bg-slate-100 rounded-xl text-[10px] text-slate-600 font-bold text-left';
                btn.textContent = ex.name;
                btn.onclick = () => {
                    currentEditLog.exercises.push({ ...ex, sets: [{ weight: 0, reps: 0 }] });
                    syncEditorUI();
                };
                libGrid.appendChild(btn);
            });
        }

        window.updateSet = (exIdx, sIdx, field, val) => { currentEditLog.exercises[exIdx].sets[sIdx][field] = parseFloat(val) || 0; };
        window.addSet = (idx) => { currentEditLog.exercises[idx].sets.push({ weight: 0, reps: 0 }); syncEditorUI(); };
        window.removeSet = (exIdx, sIdx) => { currentEditLog.exercises[exIdx].sets.splice(sIdx, 1); syncEditorUI(); };
        window.removeEx = (idx) => { currentEditLog.exercises.splice(idx, 1); syncEditorUI(); };

        window.saveWorkout = () => {
            currentEditLog.date = document.getElementById('edit-date').value;
            currentEditLog.mood = document.getElementById('edit-mood').value;
            currentEditLog.weight = parseFloat(document.getElementById('edit-weight').value);
            currentEditLog.bodyFat = parseFloat(document.getElementById('edit-fat').value);
            currentEditLog.notes = document.getElementById('edit-notes').value;
            
            const idx = appState.logs.findIndex(l => l.id === currentEditLog.id);
            if(idx > -1) appState.logs[idx] = currentEditLog;
            else appState.logs.push(currentEditLog);
            
            saveToLocal();
            renderHome();
            closeEditor(false);
        };

        window.deleteLog = (id) => { if(confirm('åˆ é™¤è®°å½•ï¼Ÿ')) { appState.logs = appState.logs.filter(l => l.id !== id); saveToLocal(); renderHome(); } };

        function saveToLocal() { localStorage.setItem('fitlog_v1_data', JSON.stringify(appState.logs)); }

        // --- æ—¥å†æ¨¡å— ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            document.getElementById('calendar-title').innerHTML = `${year} <span class="text-blue-600">${month+1}æœˆ</span>`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            for(let d=1; d<=daysInMonth; d++) {
                const dayDiv = document.createElement('div');
                const log = appState.logs.find(l => new Date(l.date).toDateString() === new Date(year, month, d).toDateString());
                dayDiv.className = `h-10 flex items-center justify-center text-xs rounded-xl cursor-pointer ${log ? 'bg-blue-50 text-blue-600 font-bold' : ''}`;
                dayDiv.textContent = d;
                dayDiv.onclick = () => showCalendarDetail(log);
                grid.appendChild(dayDiv);
            }
        }
        window.changeMonth = (dir) => { currentMonth.setMonth(currentMonth.getMonth() + dir); renderCalendar(); };
        function showCalendarDetail(log) {
            const detail = document.getElementById('calendar-detail');
            if(!log) { detail.classList.add('hidden'); return; }
            detail.classList.remove('hidden');
            detail.innerHTML = `
                <div class="bg-white rounded-3xl p-5 card-shadow border border-blue-100">
                    <h4 class="font-black text-slate-800 mb-2">${new Date(log.date).toLocaleDateString()} è®­ç»ƒæ¦‚è§ˆ</h4>
                    ${log.exercises.map(ex => `<div class="text-xs mb-1">Â· ${ex.name} (${ex.sets.length}ç»„)</div>`).join('')}
                    <button onclick="openEditor('${log.id}')" class="mt-4 w-full py-2 bg-blue-600 text-white rounded-full text-xs font-bold">æŸ¥çœ‹/ç¼–è¾‘è¯¦æƒ…</button>
                </div>
            `;
        }

        // --- ç»Ÿè®¡æ¨¡å— (Chart.js) ---
        let sbdChart = null;
        let bodyChart = null;
        function renderStats() {
            const logs = [...appState.logs].sort((a,b) => new Date(a.date) - new Date(b.date));
            const prs = { s: 0, b: 0, d: 0 };
            logs.forEach(l => l.exercises.forEach(ex => {
                const max = Math.max(...ex.sets.map(s => s.weight));
                if(ex.name.includes('æ·±è¹²')) prs.s = Math.max(prs.s, max);
                if(ex.name.includes('å§æ¨')) prs.b = Math.max(prs.b, max);
                if(ex.name.includes('ç¡¬æ‹‰')) prs.d = Math.max(prs.d, max);
            }));
            document.getElementById('pr-squat').textContent = prs.s || '--';
            document.getElementById('pr-bench').textContent = prs.b || '--';
            document.getElementById('pr-deadlift').textContent = prs.d || '--';

            const ctx1 = document.getElementById('sbd-chart').getContext('2d');
            if(sbdChart) sbdChart.destroy();
            sbdChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: logs.map(l => new Date(l.date).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'})).slice(-10),
                    datasets: [
                        { label: 'æ·±è¹²', data: logs.map(l => {
                            const ex = l.exercises.find(e => e.name.includes('æ·±è¹²'));
                            return ex ? Math.max(...ex.sets.map(s => s.weight)) : null;
                        }).slice(-10), borderColor: '#ef4444', tension: 0.3, spanGaps: true },
                        { label: 'å§æ¨', data: logs.map(l => {
                            const ex = l.exercises.find(e => e.name.includes('å§æ¨'));
                            return ex ? Math.max(...ex.sets.map(s => s.weight)) : null;
                        }).slice(-10), borderColor: '#3b82f6', tension: 0.3, spanGaps: true }
                    ]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: false } } }
            });

            const ctx2 = document.getElementById('body-chart').getContext('2d');
            if(bodyChart) bodyChart.destroy();
            bodyChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: logs.filter(l => l.weight).map(l => new Date(l.date).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'})).slice(-10),
                    datasets: [{ label: 'ä½“é‡', data: logs.filter(l => l.weight).map(l => l.weight).slice(-10), borderColor: '#f97316', tension: 0.3 }]
                },
                options: { plugins: { legend: { display: false } } }
            });
        }

        // --- åŠ¨ä½œåº“æ¨¡å— ---
        window.renderLibrary = () => {
            const list = document.getElementById('lib-list');
            const search = document.getElementById('lib-search').value.toLowerCase();
            list.innerHTML = '';
            DEFAULT_EXERCISES.filter(ex => ex.name.toLowerCase().includes(search)).forEach(ex => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-3 hover:bg-slate-50 rounded-2xl';
                div.innerHTML = `<div class="w-2.5 h-2.5 rounded-full" style="background:${GROUP_COLORS[ex.group]}"></div><div><div class="text-sm font-bold text-slate-700">${ex.name}</div><div class="text-[10px] text-slate-400">${ex.group}</div></div>`;
                list.appendChild(div);
            });
        };

        // --- è®¾ç½®ä¸å¯¼å‡º ---
        window.updateSettings = () => {
            appState.banner = document.getElementById('settings-banner').value;
            localStorage.setItem('fitlog_banner', appState.banner);
            document.getElementById('header-banner').textContent = appState.banner;
        };
        window.exportMarkdown = () => {
            let md = "# FitLog Data\n\n";
            appState.logs.forEach(l => {
                md += `## ${l.date} ${l.mood}\n- ä½“é‡: ${l.weight}kg\n- åŠ¨ä½œ:\n`;
                l.exercises.forEach(ex => {
                    md += `  - ${ex.name}: ${ex.sets.map(s => s.weight + 'kg x ' + s.reps).join(', ')}\n`;
                });
                md += `\n`;
            });
            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FitLog_Backup.md';
            a.click();
        };
        window.clearData = () => { if(confirm('æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼Ÿ')) { localStorage.clear(); location.reload(); } };

        init();
    </script>
</body>
</html>
