
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLog | æ‚¦åŠ¨è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .active-nav { color: #2563eb; font-weight: 900; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05); }
        .banner-bg { background: linear-gradient(135deg, #eff6ff 0%, #fff7ed 100%); }
        
        @media (max-width: 380px) {
            .set-input { font-size: 0.875rem !important; }
            .set-grid { gap: 0.4rem; }
            .nav-text { font-size: 12px !important; }
        }
    </style>
</head>
<body class="text-slate-900 overflow-hidden">
    <div class="flex flex-col h-screen max-w-2xl mx-auto bg-white shadow-2xl relative overflow-hidden">
        
        <!-- Header -->
        <header class="z-10 bg-white">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                <h1 class="text-2xl font-black bg-gradient-to-r from-blue-600 to-orange-500 bg-clip-text text-transparent italic">FitLog</h1>
                <span id="header-date" class="text-xs font-black text-slate-400 uppercase tracking-widest"></span>
            </div>
            <div class="px-6 py-5 banner-bg border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-1.5 h-10 bg-blue-600 rounded-full"></div>
                    <p id="header-banner" class="text-base text-slate-700 font-bold italic leading-tight"></p>
                </div>
            </div>
        </header>

        <!-- Main -->
        <main id="main-scroll" class="flex-1 overflow-y-auto custom-scrollbar bg-slate-50/50 pb-24">
            <!-- é¦–é¡µ -->
            <div id="tab-home" class="tab-content active p-4 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-600 rounded-3xl p-6 text-white card-shadow">
                        <div id="stat-total" class="text-4xl font-black">0</div>
                        <div class="text-xs opacity-80 font-bold uppercase tracking-widest mt-1">ç´¯è®¡è®­ç»ƒ</div>
                    </div>
                    <div class="bg-orange-500 rounded-3xl p-6 text-white card-shadow">
                        <div id="stat-month" class="text-4xl font-black">0</div>
                        <div class="text-xs opacity-80 font-bold uppercase tracking-widest mt-1">æœ¬æœˆè®°å½•</div>
                    </div>
                </div>
                <div class="flex justify-between items-center px-2">
                    <h2 class="text-xl font-black text-slate-800 flex items-center gap-2"><div class="w-2 h-6 bg-blue-600 rounded-full"></div>æœ€è¿‘æ´»åŠ¨</h2>
                    <button onclick="openEditor()" class="text-sm font-black text-blue-600 bg-blue-100 px-5 py-2.5 rounded-full">å¼€å§‹è®°å½•</button>
                </div>
                <div id="log-list" class="space-y-5"></div>
            </div>

            <!-- æ—¥å† -->
            <div id="tab-calendar" class="tab-content p-4 space-y-4">
                <div class="bg-white rounded-3xl p-6 border border-slate-100 card-shadow">
                    <div class="flex justify-between items-center mb-6">
                        <h2 id="calendar-title" class="text-2xl font-black text-slate-800"></h2>
                        <div class="flex gap-3">
                            <button onclick="changeMonth(-1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full text-slate-400">â†</button>
                            <button onclick="changeMonth(1)" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full text-slate-400">â†’</button>
                        </div>
                    </div>
                    <div id="calendar-days" class="grid grid-cols-7 gap-2 text-center"></div>
                </div>
                <div id="calendar-detail"></div>
            </div>

            <!-- ç»Ÿè®¡ -->
            <div id="tab-stats" class="tab-content p-4 space-y-6">
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-red-50 p-4 rounded-2xl text-center border border-red-100">
                        <div class="text-[10px] font-black text-red-400 uppercase">æ·±è¹² PR</div>
                        <div id="pr-squat" class="text-xl font-black text-red-600">--</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-2xl text-center border border-blue-100">
                        <div class="text-[10px] font-black text-blue-400 uppercase">å§æ¨ PR</div>
                        <div id="pr-bench" class="text-xl font-black text-blue-600">--</div>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-2xl text-center border border-slate-200">
                        <div class="text-[10px] font-black text-slate-400 uppercase">ç¡¬æ‹‰ PR</div>
                        <div id="pr-deadlift" class="text-xl font-black text-slate-800">--</div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-6 card-shadow space-y-8">
                    <div>
                        <h3 class="text-base font-black mb-4 text-slate-800">SBD é‡é‡è¶‹åŠ¿ (KG)</h3>
                        <canvas id="sbd-chart" height="220"></canvas>
                    </div>
                    <div>
                        <h3 class="text-base font-black mb-4 text-slate-800">ä½“é‡å˜åŒ– (KG)</h3>
                        <canvas id="weight-chart" height="220"></canvas>
                    </div>
                    <div>
                        <h3 class="text-base font-black mb-4 text-slate-800">ä½“è„‚å˜åŒ– (%)</h3>
                        <canvas id="fat-chart" height="220"></canvas>
                    </div>
                </div>
            </div>

            <!-- åº“ -->
            <div id="tab-library" class="tab-content p-4 space-y-4">
                <div class="bg-white p-5 rounded-3xl card-shadow border border-slate-100">
                    <h3 class="text-xs font-black text-slate-400 mb-3 tracking-widest">æ–°å¢åŠ¨ä½œ</h3>
                    <div class="flex flex-col gap-3">
                        <input type="text" id="lib-new-name" placeholder="åç§°" class="bg-slate-50 rounded-2xl px-4 py-3 text-base font-bold outline-none">
                        <div class="flex gap-2">
                            <select id="lib-new-group" class="flex-1 bg-slate-50 rounded-2xl px-4 py-3 font-bold outline-none">
                                <option>èƒ¸</option><option>èƒŒ</option><option>è…¿</option><option>è‚©</option><option>èƒ³è†Š</option><option>æ ¸å¿ƒ</option><option>æœ‰æ°§</option>
                            </select>
                            <button onclick="addLibraryItem()" class="bg-blue-600 text-white px-8 py-3 rounded-2xl font-black">æ·»åŠ </button>
                        </div>
                    </div>
                </div>
                <div id="lib-list" class="bg-white rounded-3xl p-2 card-shadow divide-y divide-slate-50 overflow-hidden"></div>
            </div>

            <!-- è®¾ç½® -->
            <div id="tab-settings" class="tab-content p-4 space-y-6">
                <div class="bg-white rounded-3xl p-6 card-shadow space-y-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">å¯¼å‡ºæ•°æ®</h3>
                    <button onclick="exportMarkdown()" class="w-full p-5 bg-blue-50 rounded-2xl text-base font-black text-blue-600 active:bg-blue-100 flex justify-between items-center">
                        <span>å¯¼å‡º Markdown å¤‡ä»½</span>
                        <span>ğŸ“„</span>
                    </button>
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">ç®¡ç†</h3>
                    <button onclick="clearData()" class="w-full p-5 bg-red-50 rounded-2xl text-base font-black text-red-600 active:bg-red-100">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </main>

        <!-- ç¼–è¾‘å™¨ -->
        <div id="editor-overlay" class="fixed inset-0 bg-white z-50 hidden flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-white shadow-sm">
                <button onclick="closeEditor(true)" class="text-slate-400 font-bold">æ”¾å¼ƒ</button>
                <h2 class="font-black text-xl text-slate-800">ç¼–è¾‘è®­ç»ƒ</h2>
                <button onclick="saveWorkout()" class="bg-blue-600 text-white px-8 py-2.5 rounded-full font-black">å®Œæˆ</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-6 bg-slate-50 pb-12">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">æ—¥æœŸ</label><input type="date" id="edit-date" class="w-full text-base font-black outline-none bg-transparent" onchange="syncCurrentInputsToState()"></div>
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">å¿ƒæƒ…</label><select id="edit-mood" class="w-full text-base font-black outline-none bg-transparent" onchange="syncCurrentInputsToState()"><option>ğŸ˜Š</option><option>ğŸ”¥</option><option>ğŸ˜´</option><option>ğŸ˜¤</option><option>ğŸ¤•</option></select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">ä½“é‡(KG)</label><input type="number" step="0.1" id="edit-weight" class="w-full text-base font-black outline-none bg-transparent" placeholder="0.0" onchange="syncCurrentInputsToState()"></div>
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm"><label class="text-[10px] text-slate-400 font-black block mb-1">ä½“è„‚(%)</label><input type="number" step="0.1" id="edit-fat" class="w-full text-base font-black outline-none bg-transparent" placeholder="0.0" onchange="syncCurrentInputsToState()"></div>
                </div>
                
                <div id="edit-exercises" class="space-y-5"></div>
                
                <div class="bg-white rounded-[2rem] p-6 border border-slate-100 shadow-sm">
                    <h3 class="font-black text-slate-800 text-lg mb-4">å¿«é€Ÿæ·»åŠ </h3>
                    <div id="edit-lib-grid" class="grid grid-cols-2 gap-3"></div>
                </div>
                
                <textarea id="edit-notes" placeholder="è¡¥å……å¤‡æ³¨..." class="w-full bg-white p-5 rounded-3xl border border-slate-100 min-h-[100px] text-base font-medium outline-none" onchange="syncCurrentInputsToState()"></textarea>
            </div>
        </div>

        <!-- Tab Bar -->
        <nav class="flex justify-around items-center py-4 bg-white border-t border-slate-100 absolute bottom-0 w-full z-20">
            <button onclick="switchTab('home')" class="nav-btn active-nav flex-1" data-tab="home"><div class="nav-text text-[13px] font-black uppercase">é¦–é¡µ</div></button>
            <button onclick="switchTab('calendar')" class="nav-btn flex-1" data-tab="calendar"><div class="nav-text text-[13px] font-black uppercase">æ—¥å†</div></button>
            <button onclick="switchTab('stats')" class="nav-btn flex-1" data-tab="stats"><div class="nav-text text-[13px] font-black uppercase">ç»Ÿè®¡</div></button>
            <button onclick="switchTab('library')" class="nav-btn flex-1" data-tab="library"><div class="nav-text text-[13px] font-black uppercase">åº“</div></button>
            <button onclick="switchTab('settings')" class="nav-btn flex-1" data-tab="settings"><div class="nav-text text-[13px] font-black uppercase">å¯¼å‡º</div></button>
        </nav>
    </div>

    <script>
        // --- Utils ---
        function getLocalToday() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            return (new Date(now - offset)).toISOString().split('T')[0];
        }

        // --- Data ---
        const INITIAL_LIB = [
            { id: '1', name: 'æ é“ƒæ·±è¹²', group: 'è…¿' }, { id: '2', name: 'æ é“ƒå§æ¨', group: 'èƒ¸' }, 
            { id: '3', name: 'ä¼ ç»Ÿç¡¬æ‹‰', group: 'èƒŒ' }, { id: '4', name: 'å¼•ä½“å‘ä¸Š', group: 'èƒŒ' },
            { id: '5', name: 'å“‘é“ƒå¼¯ä¸¾', group: 'èƒ³è†Š' }, { id: '6', name: 'ç«™å§¿æ¨ä¸¾', group: 'è‚©' },
            { id: '7', name: 'è·‘æ­¥', group: 'æœ‰æ°§' }
        ];

        let appState = {
            logs: JSON.parse(localStorage.getItem('fitlog_v1_data') || '[]'),
            library: JSON.parse(localStorage.getItem('fitlog_lib_v1') || JSON.stringify(INITIAL_LIB)),
            banner: 'è§è¯æ¯ä¸€æ»´æ±—æ°´çš„ä»·å€¼ã€‚'
        };

        const GROUP_COLORS = { 'èƒ¸': '#3b82f6', 'èƒŒ': '#10b981', 'è…¿': '#8b5cf6', 'è‚©': '#f97316', 'èƒ³è†Š': '#ec4899', 'æ ¸å¿ƒ': '#f59e0b', 'æœ‰æ°§': '#06b6d4' };
        let currentMonth = new Date();
        let currentEditLog = null;
        let sbdChart = null, weightChart = null, fatChart = null;

        function init() {
            document.getElementById('header-date').textContent = new Date().toLocaleDateString('zh-CN', { month: 'short', day: 'numeric', weekday: 'short' });
            document.getElementById('header-banner').textContent = appState.banner;
            renderHome();
        }

        // --- Library ---
        function addLibraryItem() {
            const name = document.getElementById('lib-new-name').value.trim();
            const group = document.getElementById('lib-new-group').value;
            if(!name) return;
            appState.library.push({ id: Date.now().toString(), name, group });
            localStorage.setItem('fitlog_lib_v1', JSON.stringify(appState.library));
            renderLibrary();
            document.getElementById('lib-new-name').value = '';
        }
        function renderLibrary() {
            const list = document.getElementById('lib-list');
            list.innerHTML = appState.library.map(item => `
                <div class="flex items-center justify-between p-5">
                    <div class="flex items-center gap-4">
                        <div class="w-4 h-4 rounded-full" style="background:${GROUP_COLORS[item.group]}"></div>
                        <div class="text-base font-black text-slate-800">${item.name}</div>
                    </div>
                    <button onclick="deleteLibItem('${item.id}')" class="text-red-300 font-bold">Ã—</button>
                </div>
            `).join('');
        }
        window.deleteLibItem = (id) => {
            appState.library = appState.library.filter(i => i.id !== id);
            localStorage.setItem('fitlog_lib_v1', JSON.stringify(appState.library));
            renderLibrary();
        };

        // --- Editor ---
        function syncCurrentInputsToState() {
            if (!currentEditLog) return;
            currentEditLog.date = document.getElementById('edit-date').value;
            currentEditLog.mood = document.getElementById('edit-mood').value;
            currentEditLog.weight = parseFloat(document.getElementById('edit-weight').value) || null;
            currentEditLog.bodyFat = parseFloat(document.getElementById('edit-fat').value) || null;
            currentEditLog.notes = document.getElementById('edit-notes').value;
        }

        window.openEditor = (id = null) => {
            document.getElementById('editor-overlay').classList.remove('hidden');
            if(id) currentEditLog = JSON.parse(JSON.stringify(appState.logs.find(l => l.id === id)));
            else currentEditLog = { id: Date.now().toString(), date: getLocalToday(), exercises: [], mood: 'ğŸ˜Š', weight: null, bodyFat: null, notes: '' };
            
            // åˆå§‹åŒ–è¾“å…¥æ¡†
            document.getElementById('edit-date').value = currentEditLog.date;
            document.getElementById('edit-mood').value = currentEditLog.mood;
            document.getElementById('edit-weight').value = currentEditLog.weight || '';
            document.getElementById('edit-fat').value = currentEditLog.bodyFat || '';
            document.getElementById('edit-notes').value = currentEditLog.notes;

            syncEditorUI();
        };
        window.closeEditor = () => document.getElementById('editor-overlay').classList.add('hidden');
        
        function syncEditorUI() {
            // æ³¨æ„ï¼šæ­¤å¤„ä¸å†é‡ç½® edit-date ç­‰é¡¶éƒ¨ input çš„ valueï¼Œä»¥é˜²è¦†ç›–ç”¨æˆ·å½“å‰è¾“å…¥
            const list = document.getElementById('edit-exercises');
            list.innerHTML = currentEditLog.exercises.map((ex, exIdx) => `
                <div class="bg-white rounded-3xl p-5 border-l-8" style="border-color:${GROUP_COLORS[ex.group]}">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-black text-lg">${ex.name}</span>
                        <button onclick="removeEx(${exIdx})" class="text-red-400 font-black text-xs">ç§»é™¤</button>
                    </div>
                    <div class="space-y-2">
                        ${ex.sets.map((s, sIdx) => `
                            <div class="grid grid-cols-4 gap-3">
                                <span class="bg-slate-50 text-slate-500 font-black h-10 flex items-center justify-center rounded-xl text-xs">${sIdx+1}</span>
                                <input type="number" value="${s.weight || 0}" class="bg-slate-50 h-10 text-center rounded-xl font-black outline-none" onchange="updateSetData(${exIdx},${sIdx},'weight',this.value)">
                                <input type="number" value="${s.reps || 0}" class="bg-slate-50 h-10 text-center rounded-xl font-black outline-none" onchange="updateSetData(${exIdx},${sIdx},'reps',this.value)">
                                <button onclick="removeSet(${exIdx},${sIdx})" class="text-slate-300 text-xl font-bold">Ã—</button>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="addSet(${exIdx})" class="w-full mt-4 py-3 bg-slate-50 text-xs font-black rounded-xl border border-dashed border-slate-200">+ æ–°å¢ç»„æ¬¡</button>
                </div>
            `).join('');

            const grid = document.getElementById('edit-lib-grid');
            grid.innerHTML = appState.library.map(item => `
                <button onclick="quickAddEx('${item.id}')" class="p-3 bg-white rounded-2xl text-sm font-black border border-slate-100 shadow-sm text-left">
                    <div class="text-[8px] opacity-40 uppercase">${item.group}</div>
                    <div class="truncate">${item.name}</div>
                </button>
            `).join('');
        }

        window.updateSetData = (exIdx, sIdx, field, val) => { 
            currentEditLog.exercises[exIdx].sets[sIdx][field] = parseFloat(val) || 0; 
        };
        window.addSet = (idx) => { 
            syncCurrentInputsToState(); // ä¿æŒåŸºç¡€æ•°æ®åŒæ­¥
            currentEditLog.exercises[idx].sets.push({ weight: 0, reps: 0 }); 
            syncEditorUI(); 
        };
        window.removeSet = (exIdx, sIdx) => { 
            syncCurrentInputsToState();
            if(currentEditLog.exercises[exIdx].sets.length > 1) { 
                currentEditLog.exercises[exIdx].sets.splice(sIdx, 1); 
                syncEditorUI(); 
            } 
        };
        window.removeEx = (idx) => { 
            syncCurrentInputsToState();
            currentEditLog.exercises.splice(idx, 1); 
            syncEditorUI(); 
        };
        window.quickAddEx = (libId) => {
            syncCurrentInputsToState();
            const item = appState.library.find(i => i.id === libId);
            currentEditLog.exercises.push({ ...item, sets: [{ weight: 0, reps: 0 }] });
            syncEditorUI();
        };

        window.saveWorkout = () => {
            syncCurrentInputsToState();
            const idx = appState.logs.findIndex(l => l.id === currentEditLog.id);
            if(idx > -1) appState.logs[idx] = currentEditLog; else appState.logs.push(currentEditLog);
            localStorage.setItem('fitlog_v1_data', JSON.stringify(appState.logs));
            renderHome(); closeEditor();
        };

        // --- Render Views ---
        function renderHome() {
            const list = document.getElementById('log-list');
            const sorted = [...appState.logs].sort((a,b) => new Date(b.date) - new Date(a.date));
            document.getElementById('stat-total').textContent = sorted.length;
            const now = new Date();
            document.getElementById('stat-month').textContent = sorted.filter(l => new Date(l.date).getMonth() === now.getMonth()).length;
            list.innerHTML = sorted.map(log => `
                <div class="bg-white rounded-[2.5rem] p-6 card-shadow space-y-5">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-4">
                            <span class="text-4xl">${log.mood}</span>
                            <div>
                                <h3 class="font-black text-lg">${log.date}</h3>
                                <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">
                                    ${log.weight ? log.weight+'kg' : '--'} / ${log.bodyFat ? log.bodyFat+'%' : '--'}
                                </p>
                            </div>
                        </div>
                        <button onclick="openEditor('${log.id}')" class="px-4 py-2 text-blue-600 font-black text-xs bg-blue-50 rounded-full">ç¼–è¾‘</button>
                    </div>
                    <div class="space-y-3">
                        ${log.exercises.map(ex => `
                            <div class="bg-slate-50/70 rounded-2xl p-4 border border-slate-100">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-sm font-black text-slate-800">${ex.name}</span>
                                    <span class="text-[9px] font-black px-2 py-0.5 rounded-full text-white" style="background:${GROUP_COLORS[ex.group]}">${ex.group}</span>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    ${ex.sets.map(s => `<div class="bg-white px-2 py-1 rounded-xl border border-slate-200 text-xs font-black text-slate-600">${s.weight}Ã—${s.reps}</div>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.switchTab = (id) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active-nav'));
            document.querySelector(`[data-tab="${id}"]`).classList.add('active-nav');
            if(id === 'calendar') renderCalendar();
            if(id === 'stats') renderStats();
            if(id === 'library') renderLibrary();
        };

        function renderStats() {
            const logs = [...appState.logs].sort((a,b) => new Date(a.date) - new Date(b.date));
            const prs = { s: 0, b: 0, d: 0 };
            logs.forEach(l => l.exercises.forEach(ex => {
                const max = Math.max(...ex.sets.map(s => s.weight));
                if(ex.name.includes('æ·±è¹²')) prs.s = Math.max(prs.s, max);
                if(ex.name.includes('å§æ¨')) prs.b = Math.max(prs.b, max);
                if(ex.name.includes('ç¡¬æ‹‰')) prs.d = Math.max(prs.d, max);
            }));
            document.getElementById('pr-squat').textContent = prs.s || '--';
            document.getElementById('pr-bench').textContent = prs.b || '--';
            document.getElementById('pr-deadlift').textContent = prs.d || '--';

            const labels = logs.slice(-10).map(l => l.date.slice(5));
            const dataS = logs.slice(-10).map(l => { const e = l.exercises.find(e => e.name.includes('æ·±è¹²')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; });
            const dataB = logs.slice(-10).map(l => { const e = l.exercises.find(e => e.name.includes('å§æ¨')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; });
            const dataD = logs.slice(-10).map(l => { const e = l.exercises.find(e => e.name.includes('ç¡¬æ‹‰')); return e ? Math.max(...e.sets.map(s => s.weight)) : null; });

            if(sbdChart) sbdChart.destroy();
            sbdChart = new Chart(document.getElementById('sbd-chart'), {
                type: 'line',
                data: { labels, datasets: [
                    { label: 'æ·±è¹²', data: dataS, borderColor: '#ef4444', tension: 0.3, spanGaps: true },
                    { label: 'å§æ¨', data: dataB, borderColor: '#3b82f6', tension: 0.3, spanGaps: true },
                    { label: 'ç¡¬æ‹‰', data: dataD, borderColor: '#1e293b', tension: 0.3, spanGaps: true }
                ] }
            });

            if(weightChart) weightChart.destroy();
            weightChart = new Chart(document.getElementById('weight-chart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'ä½“é‡', data: logs.slice(-10).map(l => l.weight), borderColor: '#f97316', backgroundColor: '#fff7ed', fill: true, tension: 0.3 }] }
            });

            if(fatChart) fatChart.destroy();
            fatChart = new Chart(document.getElementById('fat-chart'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'ä½“è„‚', data: logs.slice(-10).map(l => l.bodyFat), borderColor: '#ec4899', tension: 0.3 }] }
            });
        }

        // --- Calendar ---
        function renderCalendar() {
            const grid = document.getElementById('calendar-days'); grid.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            document.getElementById('calendar-title').textContent = `${y}å¹´ ${m+1}æœˆ`;
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            for(let d=1; d<=days; d++) {
                const dayDiv = document.createElement('div');
                const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasLog = appState.logs.some(l => l.date === iso);
                dayDiv.className = `h-10 flex items-center justify-center text-sm rounded-2xl cursor-pointer ${hasLog ? 'bg-blue-600 text-white font-black' : 'text-slate-400 font-black'}`;
                dayDiv.textContent = d;
                dayDiv.onclick = () => {
                    const log = appState.logs.find(l => l.date === iso);
                    const detail = document.getElementById('calendar-detail');
                    detail.innerHTML = log ? createLogCard(log, true) : '<div class="p-10 text-center text-slate-300 text-xs italic">æ— è®°å½•</div>';
                };
                grid.appendChild(dayDiv);
            }
        }
        function createLogCard(log) {
            return `
                <div class="bg-white p-6 rounded-3xl mt-4 space-y-3 shadow-sm border border-slate-50">
                    <div class="flex justify-between items-center"><span class="text-3xl">${log.mood}</span><span class="font-black">${log.date}</span></div>
                    ${log.exercises.map(ex => `<div class="text-xs font-bold">${ex.name}: ${ex.sets.map(s => s.weight+'Ã—'+s.reps).join(', ')}</div>`).join('')}
                </div>`;
        }
        window.changeMonth = (dir) => { currentMonth.setMonth(currentMonth.getMonth()+dir); renderCalendar(); };

        // --- Export & Clear ---
        window.exportMarkdown = () => {
            let md = "# FitLog è®­ç»ƒè®°å½•\n\n";
            [...appState.logs].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(l => {
                md += `## ${l.date} ${l.mood}\n`;
                md += `- ä½“é‡: ${l.weight || '--'}kg / ä½“è„‚: ${l.bodyFat || '--'}%\n`;
                l.exercises.forEach(ex => {
                    md += `### ${ex.name} (${ex.group})\n`;
                    ex.sets.forEach((s, i) => md += `  - ç»„${i+1}: ${s.weight}kg x ${s.reps}æ¬¡\n`);
                });
                if(l.notes) md += `\n**å¤‡æ³¨**: ${l.notes}\n`;
                md += `\n---\n\n`;
            });
            const blob = new Blob([md], {type:'text/markdown'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `FitLog_${getLocalToday()}.md`; a.click();
        };
        window.clearData = () => { if(confirm('ç¡®å®šæ¸…ç©ºï¼Ÿ')) { localStorage.clear(); location.reload(); } };

        init();
    </script>
</body>
</html>
